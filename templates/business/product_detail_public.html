<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ product.title }} â€¢ LastBite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <a href="{% url 'business:business_public' product.owner.business.id %}" class="btn btn-link">&larr; Back to Store</a>
  <div class="row g-4">
    <div class="col-md-6">
      {% if product.image %}
        <img src="{{ product.image.url }}" class="img-fluid rounded border">
      {% else %}
        <div class="border rounded p-5 text-center bg-white">No image</div>
      {% endif %}
    </div>
    <div class="col-md-6">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h2 class="h4 mb-0">{{ product.title }}</h2>
          {% if is_owner %}
            <div class="d-flex gap-2">
              <a href="{% url 'business:product_edit' product.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
            </div>
          {% endif %}
        </div>
        {% if product.description %}
          <p class="mb-2">{{ product.description }}</p>
        {% endif %}
        <div class="text-muted mb-2">Qty: {{ product.quantity }}</div>
        <div class="h5 mb-3">
          ${{ product.get_current_price|floatformat:2 }}
          {% if product.end_time and product.get_current_price != product.base_price %}
            <small class="text-muted text-decoration-line-through">${{ product.base_price|floatformat:2 }}</small>
          {% endif %}
        </div>
        
        {% if request.user.is_authenticated %}
          {% if is_owner %}
            <!-- Owner view - show bids received -->
            {% if highest_bid %}
              <div class="alert alert-info">
                <strong>Current highest bid:</strong> ${{ highest_bid.amount|floatformat:2 }}<br>
                <small class="text-muted">By: {{ highest_bid.bidder.get_full_name|default:highest_bid.bidder.username }}</small>
              </div>
            {% endif %}
            <a href="{% url 'business:bids' %}" class="btn btn-outline-primary">View All Bids</a>
          {% else %}
            <!-- Customer view - show buy and bid options -->
            <div class="d-flex gap-2 align-items-center mb-3">
              <form method="post" action="{% url 'market:add_to_cart' %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="product_id" value="{{ product.pk }}">
                <input type="hidden" name="quantity" value="1">
                <input type="hidden" name="next" value="{% url 'business:product_detail_public' product.pk %}">
                <button class="btn btn-primary" {% if product.quantity <= 0 %}disabled{% endif %}>
                  Buy Now - ${{ product.get_current_price|floatformat:2 }}
                </button>
              </form>
            </div>
            
            <!-- Bidding Section -->
            {% if is_bidding_open %}
              <div class="card mt-3 border-warning">
                <div class="card-body">
                  <h6 class="card-title">Place a Bid</h6>
                  {% if highest_bid %}
                    <p class="text-muted small mb-2">Current highest bid: <strong>${{ highest_bid.amount|floatformat:2 }}</strong></p>
                  {% else %}
                    <p class="text-muted small mb-2">No bids yet. Minimum bid: <strong>${{ min_bid|floatformat:2 }}</strong></p>
                  {% endif %}
                  <form method="post" action="{% url 'business:place_bid' product.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{% url 'business:product_detail_public' product.pk %}">
                    <div class="input-group mb-2">
                      <span class="input-group-text">$</span>
                      <input type="number" name="amount" step="0.01" min="{{ min_bid }}" value="{{ min_bid }}" class="form-control" required>
                      <button type="submit" class="btn btn-warning">Place Bid</button>
                    </div>
                    <small class="text-muted">Minimum bid: ${{ min_bid|floatformat:2 }}</small>
                  </form>
                  {% if user_bids %}
                    <div class="mt-3">
                      <small class="text-muted">Your bids:</small>
                      <ul class="list-unstyled mb-0">
                        {% for bid in user_bids|slice:":3" %}
                          <li class="small">
                            ${{ bid.amount|floatformat:2 }} - <span class="bid-time-display" data-utc-time="{{ bid.created_at.isoformat }}">{{ bid.created_at|date:"M d, Y H:i" }}</span>
                            {% if bid == highest_bid %}
                              <span class="badge bg-success">Highest</span>
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% endif %}
                  {% if product.end_time %}
                    <p class="text-muted small mt-2 mb-0">
                      <i class="fas fa-clock"></i> Bidding ends: <span class="end-time-display" data-utc-time="{{ product.end_time.isoformat }}">{{ product.end_time|date:"M d, Y H:i" }}</span>
                    </p>
                  {% endif %}
                </div>
              </div>
            {% elif product.end_time %}
              <div class="alert alert-secondary mt-3">
                <small>Bidding has ended for this product.</small>
              </div>
            {% endif %}
          {% endif %}
        {% else %}
          <!-- Not logged in -->
          <div class="alert alert-info">
            <a href="{% url 'users:login' %}?next={% url 'business:product_detail_public' product.pk %}">Login</a> to buy or place a bid.
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Convert UTC end_time to user's local timezone for display
  document.addEventListener('DOMContentLoaded', function() {
    const endTimeElements = document.querySelectorAll('.end-time-display');
    endTimeElements.forEach(function(element) {
      const utcTimeString = element.getAttribute('data-utc-time');
      if (utcTimeString) {
        const utcDate = new Date(utcTimeString);
        
        const options = { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: false
        };
        const localTimeString = utcDate.toLocaleString('en-US', options);
        element.textContent = localTimeString;
      }
    });
    
    // Convert bid timestamps
    const bidTimeElements = document.querySelectorAll('.bid-time-display');
    bidTimeElements.forEach(function(element) {
      const utcTimeString = element.getAttribute('data-utc-time');
      if (utcTimeString) {
        const utcDate = new Date(utcTimeString);
        
        const options = { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: false
        };
        const localTimeString = utcDate.toLocaleString('en-US', options);
        element.textContent = localTimeString;
      }
    });
  });
</script>
</body>
</html>
