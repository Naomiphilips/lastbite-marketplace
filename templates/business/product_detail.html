<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ product.title }} â€¢ LastBite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <a href="{% url 'business:product_list' %}" class="btn btn-link">&larr; Back to My Products</a>
  <div class="row g-4">
    <div class="col-md-6">
      {% if product.image %}
        <img src="{{ product.image.url }}" class="img-fluid rounded border">
      {% else %}
        <div class="border rounded p-5 text-center bg-white">No image</div>
      {% endif %}
    </div>
    <div class="col-md-6">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h2 class="h4 mb-0">{{ product.title }}</h2>
          <div class="d-flex gap-2">
            <a href="{% url 'business:product_edit' product.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
            <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">Delete</button>
          </div>
        </div>
        {% if product.description %}
          <p class="mb-2">{{ product.description }}</p>
        {% endif %}
        <div class="text-muted mb-2">Qty: {{ product.quantity }}</div>
        <div class="h5 mb-3">
          ${{ product.get_current_price|floatformat:2 }}
          {% if product.end_time and product.get_current_price != product.base_price %}
            <small class="text-muted text-decoration-line-through">${{ product.base_price|floatformat:2 }}</small>
          {% endif %}
        </div>
        {% if request.user.is_authenticated and is_customer %}
          <form method="post" action="{% url 'market:add_to_cart' %}" class="d-flex gap-2 align-items-center">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ product.pk }}">
            <label class="visually-hidden" for="qty">Qty</label>
            <input id="qty" type="number" name="quantity" min="1" value="1" class="form-control" style="width:80px;">
            <button class="btn btn-primary" {% if product.quantity <= 0 %}disabled{% endif %}>Add to cart</button>
          </form>
          
          <!-- Bidding Section -->
          {% if product.is_bidding_open %}
            <div class="card mt-3 border-warning">
              <div class="card-body">
                <h6 class="card-title">Place a Bid</h6>
                {% if highest_bid %}
                  <p class="text-muted small mb-2">Current highest bid: <strong>${{ highest_bid.amount|floatformat:2 }}</strong></p>
                {% else %}
                  <p class="text-muted small mb-2">No bids yet. Minimum bid: <strong>${{ min_bid|floatformat:2 }}</strong></p>
                {% endif %}
                <form method="post" action="{% url 'business:place_bid' product.pk %}">
                  {% csrf_token %}
                  <div class="input-group mb-2">
                    <span class="input-group-text">$</span>
                    <input type="number" name="amount" step="0.01" min="{{ min_bid }}" value="{{ min_bid }}" class="form-control" required>
                    <button type="submit" class="btn btn-warning">Place Bid</button>
                  </div>
                  <small class="text-muted">Minimum bid: ${{ min_bid|floatformat:2 }}</small>
                </form>
                {% if user_bids %}
                  <div class="mt-3">
                    <small class="text-muted">Your bids:</small>
                    <ul class="list-unstyled mb-0">
                      {% for bid in user_bids|slice:":3" %}
                        <li class="small">${{ bid.amount|floatformat:2 }} - <span class="bid-time-display" data-utc-time="{{ bid.created_at.isoformat }}">{{ bid.created_at|date:"M d, Y H:i" }}</span></li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endif %}
        {% if product.notes %}<p class="mt-3 mb-0 text-muted small">{{ product.notes }}</p>{% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="deleteModalLabel">Delete Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="lead">Are you sure you want to delete "<strong>{{ product.title }}</strong>"?</p>
        <p class="text-muted mb-0">This action cannot be undone.</p>
      </div>
      <div class="modal-footer border-0">
        <form method="post" action="{% url 'business:product_delete' product.pk %}">
          {% csrf_token %}
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Yes, Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% if created %}
<div class="modal fade show" id="createdModal" tabindex="-1" style="display:block; background:rgba(0,0,0,.5);" aria-modal="true" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold">Your product has been posted!</h5>
        <a href="{% url 'business:product_detail' product.pk %}" class="btn-close"></a>
      </div>
      <div class="modal-body">
        <p class="mb-3">You can create more products or view all your products.</p>
        <div class="d-flex gap-2">
          <a class="btn btn-primary" href="{% url 'business:product_create' %}">Create another</a>
          <a class="btn btn-outline-secondary" href="{% url 'business:product_list' %}">View my products</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Convert UTC bid timestamps to user's local timezone for display
  document.addEventListener('DOMContentLoaded', function() {
    const bidTimeElements = document.querySelectorAll('.bid-time-display');
    bidTimeElements.forEach(function(element) {
      const utcTimeString = element.getAttribute('data-utc-time');
      if (utcTimeString) {
        const utcDate = new Date(utcTimeString);
        // Format as: "Nov 12, 2025 15:30"
        const options = { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: false
        };
        const localTimeString = utcDate.toLocaleString('en-US', options);
        element.textContent = localTimeString;
      }
    });
  });
</script>
</body>
</html>